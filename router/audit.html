<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-router/audit">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<title data-rh="true">yAcademy OpenMEV SushiGuard Router Audit | OpenMEV</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.openmev.org/router/audit"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="yAcademy OpenMEV SushiGuard Router Audit | OpenMEV"><meta data-rh="true" name="description" content="Review Resources:"><meta data-rh="true" property="og:description" content="Review Resources:"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.openmev.org/router/audit"><link data-rh="true" rel="alternate" href="https://docs.openmev.org/router/audit" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.openmev.org/router/audit" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.b455e0e7.css">
<link rel="preload" href="/assets/js/runtime~main.5bcf3360.js" as="script">
<link rel="preload" href="/assets/js/main.451485d3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="OpenMEV icon" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo.svg" alt="OpenMEV icon" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/openmev" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link persistent">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">What is OpenMEV?</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/technical-reference/intro">Technical Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/guides/gas-pricing">Guides</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/simple-api">Minimal API Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/transaction-status">Transaction Status</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/resources">Resources and Links</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Contributing-Guidelines">Contributing and Community Guidelines</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/Ethereum-API/eth_getTransactionCount">Ethereum-API</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/RPC-Methods">OpenMEV API</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/router/audit">router</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/router/audit">yAcademy OpenMEV SushiGuard Router Audit</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">üè†</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><span class="breadcrumbs__link" itemprop="item name">router</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">yAcademy OpenMEV SushiGuard Router Audit</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>yAcademy OpenMEV review</h1><p><strong>Review Resources:</strong>
<a href="/manifoldfinance/OpenMevRouter/wiki">Wiki</a>
<a href="/manifoldfinance/OpenMevRouter/tree/main/docs">Docs and whitepaper</a></p><p><strong>Residents:</strong></p><ul><li>Jackson</li><li>engn33r</li></ul><ul><li><a href="#yacademy-openmev-review">yAcademy OpenMEV review</a><ul><li><a href="#review-summary">Review Summary</a></li><li><a href="#scope">Scope</a></li><li><a href="#code-evaluation-matrix">Code Evaluation Matrix</a></li><li><a href="#findings-explanation">Findings Explanation</a></li><li><a href="#high-findings">High Findings</a><ul><li><a href="#high---the-swap-and-stake-mechanisms-in-openmevzapper-leave-funds-in-the-contract-jackson">High - The swap and stake mechanisms in OpenMevZapper leave funds in the contract Jackson</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#high---using-normal-functions-for-fee-on-transfer-tokens-causes-value-loss-engn33r">High - Using normal functions for fee-on-transfer tokens causes value loss engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#high---backrun-arb-not-designed-for-fee-on-transfer-tokens-engn33r">High - Backrun arb not designed for fee-on-transfer tokens engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li></ul></li><li><a href="#medium-findings">Medium Findings</a><ul><li><a href="#medium---failed-flashloan-arbitrage-reverts-the-original-swap-jackson">Medium - Failed flashloan arbitrage reverts the original swap Jackson</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li></ul></li><li><a href="#low-findings">Low Findings</a><ul><li><a href="#low---edge-case-suboptimal-arb-profit-engn33r">Low - Edge case suboptimal arb profit engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#low---one-failed-arb-can-revert-otherwise-profitable-arb-engn33r">Low - One failed arb can revert otherwise profitable arb engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#low---max-approval-granted-to-spender-jackson">Low - Max approval granted to spender Jackson</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#low---no-check-for-aave-flashloan-balance-jackson">Low - No check For Aave flashloan balance Jackson</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li></ul></li><li><a href="#gas-savings-findings">Gas Savings Findings</a><ul><li><a href="#gas---use-_isnonzero-for-gas-savings-engn33r">Gas - Use _isNonZero for gas savings engn33r</a><ul><li><a href="#proof-of-concept">Proof of Concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---use-_inc-instead-of--and-_dec-instead-of----engn33r">Gas - Use _inc instead of ++ and _dec instead of -- engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---bitshifting-is-cheaper-than-multiplication-or-division-engn33r">Gas - Bitshifting is cheaper than multiplication or division engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---unnecessary-zero-initialization-engn33r">Gas - Unnecessary zero initialization engn33r</a><ul><li><a href="#proof-of-concept">Proof of Concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---payable-functions-can-save-gas-engn33r">Gas - Payable functions can save gas engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---avoid--logic-in-require-statements-engn33r">Gas - Avoid &amp;&amp; logic in require statements engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---declare-constant-internal-when-possible-engn33r">Gas - Declare constant internal when possible engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---replace-require-with-errors-in-openmevrouter-jackson">Gas - Replace require with errors in OpenMevRouter Jackson</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---remove-unused-code-jackson">Gas - Remove unused code Jackson</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---use-simple-comparison-engn33r">Gas - Use simple comparison engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---combine-reserve-value-checks-engn33r">Gas - Combine reserve value checks engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---use-msg-global-vars-directly-engn33r">Gas - Use msg global vars directly engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---remove-duplicate-internal-function-call-engn33r">Gas - Remove duplicate internal function call engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---deadline-special-case-not-aligned-with-permit-engn33r">Gas - deadline special case not aligned with permit engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---replace-pairswap-with-_asmswap-engn33r">Gas - Replace pair.swap with _asmSwap engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---remove-a-sorttokens-call-engn33r">Gas - Remove a sortTokens call engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---missing-curly-brace-engn33r">Gas - Missing curly brace engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---more-efficient-variable-swap-engn33r">Gas - More efficient variable swap engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---reduce-number-of-swaps-engn33r">Gas - Reduce number of swaps engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#gas---revert-if-zero-flashloan-profit-engn33r">Gas - Revert if zero flashloan profit engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li></ul></li><li><a href="#informational-findings">Informational Findings</a><ul><li><a href="#informational---openmevrouter-should-inherit-from-iflashborrower-and-iopenmevrouter-jackson">Informational - OpenMevRouter should inherit from IFlashBorrower and IOpenMevRouter Jackson</a><ul><li><a href="#impact">Impact</a></li></ul></li><li><a href="#informational---the-etherscan_api-key-is-present-in-plaintext-jackson">Informational - The ETHERSCAN_API key is present in plaintext Jackson</a><ul><li><a href="#impact">Impact</a></li></ul></li><li><a href="#informational---safetransferlib-does-not-match-solmates-main-branch-jackson">Informational - SafeTransferLib does not match Solmate&#x27;s main branch Jackson</a><ul><li><a href="#impact">Impact</a></li></ul></li><li><a href="#informational---incorrect-comment-engn33r-jackson">Informational - Incorrect comment engn33r, Jackson</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#informational---replace-magic-numbers-with-constants-engn33r">Informational - Replace magic numbers with constants engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#informational---typos-engn33r">Informational - Typos engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#informational---hard-coded-aave-token-list-engn33r">Informational - Hard coded Aave token list engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#informational---inconsistency-in-weth-transfers-engn33r">Informational - Inconsistency in WETH transfers engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#informational---safeapprove-vulnerable-to-double-withdraw-engn33r">Informational - safeApprove vulnerable to double withdraw engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#informational---same-frontrunning-weaknesses-as-uniswapsushiswap-engn33r">Informational - Same frontrunning weaknesses as Uniswap/SushiSwap engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#informational---kashi-flashloanable-tokens-assumed-same-as-aave-engn33r">Informational - Kashi flashloanable tokens assumed same as aave engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li><li><a href="#informational----engn33r">Informational -  engn33r</a><ul><li><a href="#proof-of-concept">Proof of concept</a></li><li><a href="#impact">Impact</a></li><li><a href="#recommendation">Recommendation</a></li></ul></li></ul></li><li><a href="#final-remarks">Final remarks</a><ul><li><a href="#engn33r">engn33r</a></li><li><a href="#jackson">Jackson</a></li></ul></li><li><a href="#about-yacademy">About yAcademy</a></li><li><a href="#appendix-and-faq">Appendix and FAQ</a></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="review-summary">Review Summary<a class="hash-link" href="#review-summary" title="Direct link to heading">‚Äã</a></h2><p><strong>OpenMEV</strong></p><p>The purpose of OpenMEVRouter is to offer a drop-in replacement to a similar Uniswap/SushiSwap router. While enabling exchanges with UniSwap and SushiSwap, it also protects against direct MEV arbitrage (arb) between the two platforms by performing the arb within the DEX swap process. This leaves no arbitrage opportunities for MEV searches.</p><p>The main branch of the OpenMEV <a href="/manifoldfinance/OpenMevRouter">Repo</a> was reviewed over 22 days, 4 of which were used to create an initial overview of the contract. The code review was performed between May 12 and June 3, 2022. The code was reviewed by 2 residents for a total of 59 man hours (engn33r: 34 hours, and Jackson 25 hours). The repository was under active development during the review, but the review was limited to <a href="/manifoldfinance/OpenMevRouter/commit/8648277c0a89d0091f959948682543bdcf0c280b">one specific commit</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="scope">Scope<a class="hash-link" href="#scope" title="Direct link to heading">‚Äã</a></h2><p><a href="/manifoldfinance/OpenMevRouter">Code Repo</a>
<a href="/manifoldfinance/OpenMevRouter/commit/8648277c0a89d0091f959948682543bdcf0c280b">Commit</a></p><p>The commit reviewed was 8648277c0a89d0091f959948682543bdcf0c280b. The review covered the entire repository at this specific commit but focused on the contracts directory.</p><p>After the findings were presented to the OpenMEV team, fixes were made and included in several PRs.</p><p>The review was a time-limited review to provide rapid feedback on potential vulnerabilities. The review was not a full audit. The review did not explore all potential attack vectors or areas of vulnerability and may not have identified all potential issues.</p><p>yAcademy and the residents make no warranties regarding the security of the code and do not warrant that the code is free from defects. yAcademy and the residents do not represent nor imply to third parties that the code has been audited nor that the code is free from defects. Manifold and third parties should use the code at their own risk.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="code-evaluation-matrix">Code Evaluation Matrix<a class="hash-link" href="#code-evaluation-matrix" title="Direct link to heading">‚Äã</a></h2><table><thead><tr><th>Category</th><th>Mark</th><th>Description</th></tr></thead><tbody><tr><td>Access Control</td><td>Good</td><td>The onlyOwner modifier was only applied to the <code>harvest()</code> function. Access controls existed on the relevant callback functions in OpenMevRouter.sol for flashloans. msg.sender is properly used so that the user cannot perform actions they should not be able to. Access controls are applied where needed.</td></tr><tr><td>Mathematics</td><td>Average</td><td>Solidity 0.8.13 is used, which provides overflow and underflow protect. There was no unusually complex math beyond the Uint512 library. The <code>sqrt512()</code> function using the Karatsuba Square Root method is an unusual and potentially custom implementation.</td></tr><tr><td>Complexity</td><td>Average</td><td>Many function names and implementations are borrowed from UniswapV2 contracts and BeefySwap&#x27;s zapper. This reduces the amount of custom development work necessary. The primary source of complexity is the backrun swap arb process and the equations derived for that purpose.</td></tr><tr><td>Libraries</td><td>Good</td><td>A custom OpenMevLibrary contract is based heavily on the UniswapV2Library contract. The Uint512 contract supports math operations for uint512 integers comprised of two uint256 integers. SafeTransferLib and ERC20 libraries are imported by OpenMevRouter but are commonly used contracts.</td></tr><tr><td>Decentralization</td><td>Good</td><td>The onlyOwner modifier on the <code>harvest()</code> function indicates there is some centralization risk, but it is expected that Sushi governance will take this role and can be considered a trusted party.</td></tr><tr><td>Code stability</td><td>Good</td><td>Changes were reviewed at a specific commit hash and the scope was not expanded after the review was started. The code reviewed had nearly all features implemented.</td></tr><tr><td>Documentation</td><td>Good</td><td>Comments existed in many places, but were lacking in key areas. As one example, identically named _updateReward functions existed in Gauge.sol, ExtraReward.sol and VeYfiRewards.sol, but no comments existed on either function and no explanation of the differences of these identically-named function existed. It would be best if more thorough comments and documentation was added throughout the code to better explain the purpose of different functions and specific math that is performed. No developer documentation like gitbooks was observed for veYFI at the time of review.</td></tr><tr><td>Monitoring</td><td>Average</td><td>Only <code>_backrunSwaps()</code> emitted an event. However, the UniswapV2 Router does not emit any events and the OpenMevRouter contracts prioritize gas savings, so additional events may not be necessary.</td></tr><tr><td>Testing and verification</td><td>Average</td><td>Brownie tests and foundry tests were written. The foundry tests were more comprehensive that the brownie tests, but getting the exact test coverage numbers with foundry is still <a href="/foundry-rs/foundry/issues/99">a work in progress</a> at the time this review was performed. The coverage could be improved to test for the edge cases introduced by modifications to the forked Uniswap and BeefySwap contracts as demonstrated by the findings.</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_mojV" id="findings-explanation">Findings Explanation<a class="hash-link" href="#findings-explanation" title="Direct link to heading">‚Äã</a></h2><p>Findings are broken down into sections by their respective impact:</p><ul><li>Critical, High, Medium, Low impact<ul><li>These are findings that range from attacks that may cause loss of funds, impact control/ownership of the contracts, or cause any unintended consequences/actions that are outside the scope of the requirements,</li></ul></li><li>Gas savings<ul><li>Findings that can improve the gas efficiency of the contracts</li></ul></li><li>Informational<ul><li>Findings including recommendations and best practices</li></ul></li></ul><hr><h2 class="anchor anchorWithStickyNavbar_mojV" id="high-findings">High Findings<a class="hash-link" href="#high-findings" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-high---the-swap-and-stake-mechanisms-in-openmevzapper-leave-funds-in-the-contract-jackson">1. High - The swap and stake mechanisms in OpenMevZapper leave funds in the contract (Jackson)<a class="hash-link" href="#1-high---the-swap-and-stake-mechanisms-in-openmevzapper-leave-funds-in-the-contract-jackson" title="Direct link to heading">‚Äã</a></h3><p>Half of the input amount in both <code>swapAndStakeLiquidity</code> and <code>swapETHAndStakeLiquidity</code> is used as the <code>swapAmountIn</code> when atomically swapping and staking.  However, this leaves funds in the contract due to the reserve asset ratio change post-swap.  See <a href="https://blog.alphaventuredao.io/onesideduniswap/" target="_blank" rel="noopener noreferrer">&quot;Optimal One-sided Supply to Uniswap&quot;</a> for more information.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept">Proof of concept<a class="hash-link" href="#proof-of-concept" title="Direct link to heading">‚Äã</a></h4><p>Both <!-- -->[<code>swapAdStakeLiquidity</code>][link]<!-- -->(manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L126-L159) and <!-- -->[<code>swapETHAndStakeLiquidity</code>][link]<!-- -->(manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol)-L195) take the input tokens or ETH sent by a user, divide it by 2, swap it into the B token, and stake these tokens as a pair.  However, this approach leaves some of the B token in the contract due to the reserve asset ratio change before and after the swap.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact">Impact<a class="hash-link" href="#impact" title="Direct link to heading">‚Äã</a></h4><p>High.  The funds are not returned to the user, and will likely be swept by Sushi governance during a call to <code>harvest</code>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation">Recommendation<a class="hash-link" href="#recommendation" title="Direct link to heading">‚Äã</a></h4><p>Use the formula found in <a href="https://blog.alphaventuredao.io/onesideduniswap/" target="_blank" rel="noopener noreferrer">&quot;Optimal One-sided Supply to Uniswap&quot;</a> for the <code>swapAmountIn</code>, rather than <code> / 2</code>.</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#6F42C1">sqrt</span><span style="color:#24292EFF">(</span></div><div class="line"><span style="color:#24292EFF">    reserveIn.</span><span style="color:#6F42C1">mul</span><span style="color:#24292EFF">(userIn.</span><span style="color:#6F42C1">mul</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">3988000</span><span style="color:#24292EFF">) </span><span style="color:#D32F2F">+</span><span style="color:#24292EFF"> reserveIn.</span><span style="color:#6F42C1">mul</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">3988009</span><span style="color:#24292EFF">)))</span></div><div class="line"><span style="color:#24292EFF">        .</span><span style="color:#6F42C1">sub</span><span style="color:#24292EFF">(reserveIn.</span><span style="color:#6F42C1">mul</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">1997</span><span style="color:#24292EFF">)) </span><span style="color:#D32F2F">/</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">1994</span><span style="color:#24292EFF">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#88C0D0">sqrt</span><span style="color:#D8DEE9FF">(</span></div><div class="line"><span style="color:#D8DEE9FF">    reserveIn</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">mul</span><span style="color:#D8DEE9FF">(userIn</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">mul</span><span style="color:#D8DEE9FF">(</span><span style="color:#B48EAD">3988000</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">+</span><span style="color:#D8DEE9FF"> reserveIn</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">mul</span><span style="color:#D8DEE9FF">(</span><span style="color:#B48EAD">3988009</span><span style="color:#ECEFF4">)))</span></div><div class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">sub</span><span style="color:#D8DEE9FF">(reserveIn</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">mul</span><span style="color:#D8DEE9FF">(</span><span style="color:#B48EAD">1997</span><span style="color:#ECEFF4">))</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">/</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1994</span><span style="color:#81A1C1">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-high---using-normal-functions-for-fee-on-transfer-tokens-causes-value-loss-engn33r">2. High - Using normal functions for fee-on-transfer tokens causes value loss (engn33r)<a class="hash-link" href="#2-high---using-normal-functions-for-fee-on-transfer-tokens-causes-value-loss-engn33r" title="Direct link to heading">‚Äã</a></h3><p>Uniswap&#x27;s code relies on the assumption that functions without direct support for fee-on-transfer tokens, like <code>removeLiquidityETH</code>, will revert. This assumption is invalid in OpenMevRouter. The difference is that Uniswap routers are designed to <a href="https://docs.uniswap.org/protocol/V2/reference/smart-contracts/router-02" target="_blank" rel="noopener noreferrer">not hold token balance</a>, which <a href="https://etherscan.io/address/0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D" target="_blank" rel="noopener noreferrer">the etherscan token balance confirms</a>. In comparison, the docs for OpenMevRouter.sol show it stores value that is later collected with the <code>harvest()</code> function. If enough fee-on-transfer tokens are held by the OpenMevRouter contract, functions such as <code>removeLiquidityETH()</code> can be called instead of <code>removeLiquidityETHSupportingFeeOnTransferTokens()</code> and the function will not revert. This leads to the OpenMevRouter contract losing value due to the fees paid for the fee-on-transfer transfer.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-1">Proof of concept<a class="hash-link" href="#proof-of-concept-1" title="Direct link to heading">‚Äã</a></h4><p>The NatSpec comment for <code>removeLiquidityETHSupportingFeeOnTransferTokens()</code> includes</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="code-container"><code><div class="line"><span style="color:undefined">Identical to removeLiquidityETH, but succeeds for tokens that take a fee on transfer</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="code-container"><code><div class="line"><span style="color:undefined">Identical to removeLiquidityETH, but succeeds for tokens that take a fee on transfer</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><p>The only difference in these functions, and what is implied to cause the revert condition in <code>removeLiquidityETH()</code>, is the amount used in <code>safeTransfer()</code>. <code>removeLiquidityETH()</code> has an amount of <code>amountToken</code>, while <code>removeLiquidityETHSupportingFeeOnTransferTokens()</code> uses <code>ERC20(token).balanceOf(address(this)) - balanceBefore</code>. This does cause a revert in Uniswap&#x27;s code because of the Uniswap assumption that the router holds no token balance, but OpenMevRouter can hold a token balance.</p><p>The process of value loss is:</p><ol><li>Fee-on-transfer token is held by the router. This can happen either with an initial deposit by the Manifold team or from backrun arbitrage profits. The devs suggested the tokens that will be sent to the router will likely be tokens that Aave does not support flashloans for, which could include lesser known tokens with fee-on-transfer support.</li><li>User wants to remove liquidity from WETH-ERC20 pair where the ERC20 has a non-zero fee-on-transfer. Instead of using  <code>removeLiquidityETHSupportingFeeOnTransferTokens()</code>, the user calls <code>removeLiquidityETH()</code>.</li><li>The code of <code>removeLiquidityETHSupportingFeeOnTransferTokens()</code> and <code>removeLiquidityETH()</code> is identical except for the amount in <code>ERC20(token).safeTransfer()</code>. The <code>amountToken</code> value used in <code>removeLiquidityETH()</code> is greater than the amount of fee-on-transfer tokens received from the <code>removeLiquidity()</code> call, so the amount transferred to the user will include some of the token balance that was held by the router before the user&#x27;s remove liquidity interaction.</li><li>Result: The router lost value in the form of the transfer-on-fee token</li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-1">Impact<a class="hash-link" href="#impact-1" title="Direct link to heading">‚Äã</a></h4><p>High. Value can be lost from the router if the router stores fee-on-transfer tokens. While it may be unlikely for OpenMevRouter.sol to hold many fee-on-transfer tokens (note: USDT could become fee-on-transfer in the future), value loss would occur if the scenario does arise and no protections prevent against this.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-1">Recommendation<a class="hash-link" href="#recommendation-1" title="Direct link to heading">‚Äã</a></h4><p>The router should follow the Uniswap assumptions and not store value. Instead, the profits from any arbs should be stored in a separate contract where it can be flashloaned to the router for arbitrage opportunities. This would impact the <code>harvest()</code> and <code>_backrunSwaps()</code> functions at a minimum, and most likely require some redesigning of the overall contract.</p><p>If there is a preference to maintain the current design where the router holds value, add stricter checks to functions not designed for fee-on-transfer tokens. For example, a rewrite of <code>removeLiquidityETH()</code> logic:</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#6F42C1">ensure</span><span style="color:#24292EFF">(deadline);</span></div><div class="line"><span style="color:#1976D2">address</span><span style="color:#24292EFF"> weth </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> WETH09;</span></div><div class="line"><span style="color:#1976D2">uint256</span><span style="color:#24292EFF"> balanceBefore </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">ERC20</span><span style="color:#24292EFF">(token).</span><span style="color:#6F42C1">balanceOf</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">address</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">this</span><span style="color:#24292EFF">));</span></div><div class="line"><span style="color:#24292EFF">(amountToken</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amountETH) </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">removeLiquidity</span><span style="color:#24292EFF">(</span></div><div class="line"><span style="color:#24292EFF">    token</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    weth</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    liquidity</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    amountTokenMin</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    amountETHMin</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#1976D2">address</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">this</span><span style="color:#24292EFF">)</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">    deadline</span></div><div class="line"><span style="color:#24292EFF">);</span></div><div class="line"><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (amountToken !</span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">ERC20</span><span style="color:#24292EFF">(token).</span><span style="color:#6F42C1">balanceOf</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">address</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">this</span><span style="color:#24292EFF">)) </span><span style="color:#D32F2F">-</span><span style="color:#24292EFF"> balanceBefore) </span><span style="color:#D32F2F">revert</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">TokenIsFeeOnTransfer</span><span style="color:#24292EFF">();</span></div><div class="line"><span style="color:#6F42C1">ERC20</span><span style="color:#24292EFF">(token).</span><span style="color:#6F42C1">safeTransfer</span><span style="color:#24292EFF">(to</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amountToken);</span></div><div class="line"><span style="color:#6F42C1">IWETH</span><span style="color:#24292EFF">(weth).</span><span style="color:#6F42C1">withdraw</span><span style="color:#24292EFF">(amountETH);</span></div><div class="line"><span style="color:#24292EFF">SafeTransferLib.</span><span style="color:#6F42C1">safeTransferETH</span><span style="color:#24292EFF">(to</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amountETH);</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#88C0D0">ensure</span><span style="color:#D8DEE9FF">(deadline</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#8FBCBB">address</span><span style="color:#D8DEE9FF"> weth </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> WETH09</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#8FBCBB">uint256</span><span style="color:#D8DEE9FF"> balanceBefore </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">ERC20</span><span style="color:#D8DEE9FF">(token</span><span style="color:#ECEFF4">).</span><span style="color:#88C0D0">balanceOf</span><span style="color:#D8DEE9FF">(</span><span style="color:#8FBCBB">address</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">))</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountToken</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amountETH</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">removeLiquidity</span><span style="color:#D8DEE9FF">(</span></div><div class="line"><span style="color:#D8DEE9FF">    token</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    weth</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    liquidity</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    amountTokenMin</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    amountETHMin</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#8FBCBB">address</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">),</span></div><div class="line"><span style="color:#D8DEE9FF">    deadline</span></div><div class="line"><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountToken !</span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">ERC20</span><span style="color:#D8DEE9FF">(token</span><span style="color:#ECEFF4">).</span><span style="color:#88C0D0">balanceOf</span><span style="color:#D8DEE9FF">(</span><span style="color:#8FBCBB">address</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">))</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">-</span><span style="color:#D8DEE9FF"> balanceBefore</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">revert</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">TokenIsFeeOnTransfer</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#88C0D0">ERC20</span><span style="color:#D8DEE9FF">(token</span><span style="color:#ECEFF4">).</span><span style="color:#88C0D0">safeTransfer</span><span style="color:#D8DEE9FF">(to</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amountToken</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#88C0D0">IWETH</span><span style="color:#D8DEE9FF">(weth</span><span style="color:#ECEFF4">).</span><span style="color:#88C0D0">withdraw</span><span style="color:#D8DEE9FF">(amountETH</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">SafeTransferLib</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">safeTransferETH</span><span style="color:#D8DEE9FF">(to</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amountETH</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-high---backrun-arb-not-designed-for-fee-on-transfer-tokens-engn33r">3. High - Backrun arb not designed for fee-on-transfer tokens (engn33r)<a class="hash-link" href="#3-high---backrun-arb-not-designed-for-fee-on-transfer-tokens-engn33r" title="Direct link to heading">‚Äã</a></h3><p>The backrun process is performed for any swap, but the backrun process is not designed for fee-on-transfer tokens. Because the router contract may hold fee-on-transfer tokens, the router contract may lose some of this stored value to fees when performing an arb involving a fee-on-transfer token.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-2">Proof of concept<a class="hash-link" href="#proof-of-concept-2" title="Direct link to heading">‚Äã</a></h4><p>While Aave and Kashi do not currently allow flashloans on any fee-on-transfer tokens, this call of <code>_arb()</code> using internal router contract funds is problematic:
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></p><p>The two swaps are performed with <code>_asmSwap()</code>, which have a <code>safeTransfer()</code> performed first to send the token to the pair address.</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li></ul><p>It is assumed that the <code>amountOut</code> value calculated by <code>OpenMevLibrary.getAmountOut()</code> accurately stores the amount of tokens that the router contract receives from the swap process. Instead, to support fee-on-transfer tokens, a calculation of <code>ERC20(token).balanceOf(address(this)) - balanceBefore</code> as found in the router function <code>removeLiquidityETHSupportingFeeOnTransferTokens()</code> should be used.</p><p>The <code>_arb()</code> fuction can even cause problems when neither the first nor last token is a fee-on-transfer token, but one of the intermediate swaps uses a fee-on-transfer token. Because the <code>_backrunSwaps()</code> function <a href="/router/[link](manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol)">loops through the array of swaps</a>, any of the backrun swaps that involve a fee-on-transfer token could be problematic.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-2">Impact<a class="hash-link" href="#impact-2" title="Direct link to heading">‚Äã</a></h4><p>High. The router contract can lose funds when paying fees for fee-on-transfer token transfers.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-2">Recommendation<a class="hash-link" href="#recommendation-2" title="Direct link to heading">‚Äã</a></h4><p>If the router is redesigned to not hold fee-on-transfer tokens, the backrun would likely revert because the math is not designed for fee-on-transfer tokens. The easiest solution is to remove the <code>_backrunSwaps()</code> calls when a fee-on-transfer swap is involved. Another option is to write a new <code>_arb()</code> function that supports fee-on-transfer arbitrage.</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="medium-findings">Medium Findings<a class="hash-link" href="#medium-findings" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-medium---failed-flashloan-arbitrage-reverts-the-original-swap-jackson">1. Medium - Failed flashloan arbitrage reverts the original swap (Jackson)<a class="hash-link" href="#1-medium---failed-flashloan-arbitrage-reverts-the-original-swap-jackson" title="Direct link to heading">‚Äã</a></h3><p>If one of the backrun flashloan arbitrages fails to return a profit, the original swap is reverted.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-3">Proof of concept<a class="hash-link" href="#proof-of-concept-3" title="Direct link to heading">‚Äã</a></h4><p>These nes include the revert for each flashloan [<a href="/router/[link](manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol)">1</a>, <a href="/router/[link](manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol)">2</a>].</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-3">Impact<a class="hash-link" href="#impact-3" title="Direct link to heading">‚Äã</a></h4><p>Medium. While this will not involve a loss of user funds, it will result it a poor user experience when user swaps are unecessarily reverted.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-3">Recommendation<a class="hash-link" href="#recommendation-3" title="Direct link to heading">‚Äã</a></h4><p>Use a try-catch when executing the flashloans such that if they revert, the entire swap is not also reverted.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="low-findings">Low Findings<a class="hash-link" href="#low-findings" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-low---edge-case-suboptimal-arb-profit-engn33r">1. Low - Edge case suboptimal arb profit (engn33r)<a class="hash-link" href="#1-low---edge-case-suboptimal-arb-profit-engn33r" title="Direct link to heading">‚Äã</a></h3><p>There can be cases where <code>contractAssetBalance &gt;= optimalAmount</code> is not true, but using the available contractAssetBalance is still cheaper than using a flashloan with a fee. For example, if <code>contractAssetBalance = optimalAmount - 1</code>, using <code>contractAssetBalance</code> will normally produce a superior result to using a flashloan.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-4">Proof of concept<a class="hash-link" href="#proof-of-concept-4" title="Direct link to heading">‚Äã</a></h4><p>The logic branch checks if <code>contractAssetBalance &gt;= optimalAmount</code>, otherwise a flashloan is used
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-4">Impact<a class="hash-link" href="#impact-4" title="Direct link to heading">‚Äã</a></h4><p>Low. This is an edge case that may be rare, but can reduce the profits of the router. Hypothetically this could be gamed by liquidity providers looking to increase yield through flashloan fees on certain assets in Aave or Kashi, because the fees are paid by OpenMevRouter arb profits.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-4">Recommendation<a class="hash-link" href="#recommendation-4" title="Direct link to heading">‚Äã</a></h4><p>When calculating the optimalAmount for the backrun process, account for the profit loss due to Aave or Kashi fees.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-low---one-failed-arb-can-revert-otherwise-profitable-arb-engn33r">2. Low - One failed arb can revert otherwise profitable arb (engn33r)<a class="hash-link" href="#2-low---one-failed-arb-can-revert-otherwise-profitable-arb-engn33r" title="Direct link to heading">‚Äã</a></h3><p>The <code>_backrunSwaps()</code> function may loop through multiple swaps to arbitrage each one. If one of these swaps does not have a sufficiently profitable opportunity or has a failed flashloan, the profitable opportunity from the other swaps may be missed.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-5">Proof of concept<a class="hash-link" href="#proof-of-concept-5" title="Direct link to heading">‚Äã</a></h4><p>The <code>_bacruSwaps()</code> function <!-- -->[loops through the array of swaps]<!-- -->(<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L877">link</a>. Imagine a scenario where <code>_backrunSwaps()</code> is called with a swaps array of length 4. Assume the 1st, 2nd, and 4th backrun swaps are profitable, but the 3rd backrun swap is not. Performing this series of four backrun swaps can still be net profitable even if one of the individual backrun swaps is not. The reason the 3rd backrun swap is not profitable may be because the flashloan fee costs more than the profit of this arb, which reverts <!-- -->[here]<!-- -->(<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L966">link</a> or <a href="/router/[link](manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol)">here</a>, or <a href="/router/[link](manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol)">a similar revert can happen</a> if the router contract funds are used for the arb and the amount received is less than expected.</p><p>The result is the transaction reverts and OpenMevRouter will miss out on the arb profits if the swaps had been completed even if one individual backrun swap wasn&#x27;t profitable.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-5">Impact<a class="hash-link" href="#impact-5" title="Direct link to heading">‚Äã</a></h4><p>Low. This is an edge case that may be rare, but can reduce the profits of the router.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-5">Recommendation<a class="hash-link" href="#recommendation-5" title="Direct link to heading">‚Äã</a></h4><p>A single flashloan or arb opportunity resulting in no profit should not revert the entire transaction. Instead, that specific backrun swap arb should be skipped. It is not even necessary to skip an unprofitable backrun swap if there is a positive net profit that is calculated at the start of the <code>_backrunSwaps()</code> function.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-low---max-approval-granted-to-spender-jackson">3. Low - Max approval granted to spender (Jackson)<a class="hash-link" href="#3-low---max-approval-granted-to-spender-jackson" title="Direct link to heading">‚Äã</a></h3><p>Maximum approvals should be avoided, particularly when the necessary amount is known.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-6">Proof of concept<a class="hash-link" href="#proof-of-concept-6" title="Direct link to heading">‚Äã</a></h4><p><code>ERC20(token).safeApprove(spender, type(uint256).max);</code> in <code>_approveTokenIfNeeded</code> approves the spend to spent the entire balance.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-6">Impact<a class="hash-link" href="#impact-6" title="Direct link to heading">‚Äã</a></h4><p>Low. Assuming nothing problematic occurs this is not a problem.  However, it is a level of protection in case of attack.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-6">Recommendation<a class="hash-link" href="#recommendation-6" title="Direct link to heading">‚Äã</a></h4><p>Only approve what is necessary for the transaction when it is known prior to granting approval.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-low---no-check-for-aave-flashloan-balance-jackson">4. Low - No check For Aave flashloan balance (Jackson)<a class="hash-link" href="#4-low---no-check-for-aave-flashloan-balance-jackson" title="Direct link to heading">‚Äã</a></h3><p><code>_backrunSwaps</code> in <code>OpenMevRouter</code> checks that Kashi has the necessary liqudity to take a flashloan against, but does not check that Aave does as well.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-7">Proof of concept<a class="hash-link" href="#proof-of-concept-7" title="Direct link to heading">‚Äã</a></h4><p>L915 of OpenMevRouter</p><p><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-7">Impact<a class="hash-link" href="#impact-7" title="Direct link to heading">‚Äã</a></h4><p>Low. It is unlikely that Aave will not have the necessary liquidity for the flashloan.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-7">Recommendation<a class="hash-link" href="#recommendation-7" title="Direct link to heading">‚Äã</a></h4><p>Check that Aave contains the necessary liquidity at the time of the flashloan as is done for Kashi. A fix is underway in <a href="/manifoldfinance/OpenMevRouter/pull/40">PR #40</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="gas-savings-findings">Gas Savings Findings<a class="hash-link" href="#gas-savings-findings" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-gas---use-_isnonzero-for-gas-savings-engn33r">1. Gas - Use <code>_isNonZero()</code> for gas savings (engn33r)<a class="hash-link" href="#1-gas---use-_isnonzero-for-gas-savings-engn33r" title="Direct link to heading">‚Äã</a></h3><p>There is a gas efficient <code>_isNonZero()</code> function that is not used in two places. Otherwise, <code>!= 0</code> is preferred to <code>&gt; 0</code> when comparing a uint to zero.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-8">Proof of Concept<a class="hash-link" href="#proof-of-concept-8" title="Direct link to heading">‚Äã</a></h4><p>Two instances of this were found:</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L68">link</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-8">Impact<a class="hash-link" href="#impact-8" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-8">Recommendation<a class="hash-link" href="#recommendation-8" title="Direct link to heading">‚Äã</a></h4><p>Replace <code>&gt; 0</code> with <code>!= 0</code> to save gas. Even better, use the existing <code>_isNonZero()</code> function in OpenMevLibrary.sol.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-gas---use-_inc-instead-of--and-_dec-instead-of----engn33r">2. Gas - Use <code>_inc()</code> instead of <code>++</code> and <code>_dec()</code> instead of <code>--</code> (engn33r)<a class="hash-link" href="#2-gas---use-_inc-instead-of--and-_dec-instead-of----engn33r" title="Direct link to heading">‚Äã</a></h3><p>Gas efficient functions <code>_inc()</code> and <code>_dec()</code> should be used to replace normal increments and decrements. Otherwise, if these functions were not available, use prefix is preferred to postfix for gas efficiency. In other words, use <code>++i</code> instead of <code>i++</code>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-9">Proof of concept<a class="hash-link" href="#proof-of-concept-9" title="Direct link to heading">‚Äã</a></h4><p>There is one instance of an increment improvement:</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L66">link</a></li></ul><p>There are two instances of a double decrement that could be replaced with <code>_dec(_decr())</code> or with <code>unchecked { length - 2; }</code>:</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol">ref</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-9">Impact<a class="hash-link" href="#impact-9" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-9">Recommendation<a class="hash-link" href="#recommendation-9" title="Direct link to heading">‚Äã</a></h4><p>Increment with prefix addition and not postfix in for loops. Even better, use <code>_inc()</code> and <code>_dec()</code>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-gas---bitshifting-is-cheaper-than-multiplication-or-division-engn33r">3. Gas - Bitshifting is cheaper than multiplication or division (engn33r)<a class="hash-link" href="#3-gas---bitshifting-is-cheaper-than-multiplication-or-division-engn33r" title="Direct link to heading">‚Äã</a></h3><p>Bitshifting is cheaper than multiplication or division. Multiplication and division can be replaced by a bitshift easily when a multiple of two is involved.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-10">Proof of concept<a class="hash-link" href="#proof-of-concept-10" title="Direct link to heading">‚Äã</a></h4><p>There are two instance of divide by 2 operations that can use bitshifting for gas efficiency:</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/Uint512.sol">ref</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-10">Impact<a class="hash-link" href="#impact-10" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-10">Recommendation<a class="hash-link" href="#recommendation-10" title="Direct link to heading">‚Äã</a></h4><p>Replace multiplication and vision by a bitshift when a power of two is involved.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-gas---unnecessary-zero-initialization-engn33r">4. Gas - Unnecessary zero initialization (engn33r)<a class="hash-link" href="#4-gas---unnecessary-zero-initialization-engn33r" title="Direct link to heading">‚Äã</a></h3><p>Initializing an int or uint to zero is unnecessary, because solidity defaults int/uint variables to a zero value. Removing the initialization to zero can save gas.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-11">Proof of Concept<a class="hash-link" href="#proof-of-concept-11" title="Direct link to heading">‚Äã</a></h4><p>Several instances of this were found:</p><ul><li>[link]<!-- -->(manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libstd/OpenMevErrors.sol#L71</li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-11">Impact<a class="hash-link" href="#impact-11" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-11">Recommendation<a class="hash-link" href="#recommendation-11" title="Direct link to heading">‚Äã</a></h4><p>Remove the explicit uint variable initializations to zero.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="5-gas---payable-functions-can-save-gas-engn33r">5. Gas - Payable functions can save gas (engn33r)<a class="hash-link" href="#5-gas---payable-functions-can-save-gas-engn33r" title="Direct link to heading">‚Äã</a></h3><p>If there is no risk of a function accidentally receiving ether, such as a function with the onlyOwner modifier, this function can use the payable modifier to save gas.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-12">Proof of concept<a class="hash-link" href="#proof-of-concept-12" title="Direct link to heading">‚Äã</a></h4><p>The following functions have the onlyOwner modifier and can be marked as payable</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/TwoStepOwnable.sol#L66">link</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/TwoStepOwnable.sol#L80">link</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-12">Impact<a class="hash-link" href="#impact-12" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-12">Recommendation<a class="hash-link" href="#recommendation-12" title="Direct link to heading">‚Äã</a></h4><p>Mark functions that have onlyOwner as payable for gas savings. This might not be aesthetically pleasing, but it works.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="6-gas---avoid--logic-in-require-statements-engn33r">6. Gas - Avoid &amp;&amp; logic in require statements (engn33r)<a class="hash-link" href="#6-gas---avoid--logic-in-require-statements-engn33r" title="Direct link to heading">‚Äã</a></h3><p>Using &amp;&amp; logic in require statements uses more gas than using separate require statements. Dividing the logic into multiple require statements is more gas efficient.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-13">Proof of concept<a class="hash-link" href="#proof-of-concept-13" title="Direct link to heading">‚Äã</a></h4><p>One instance of require with &amp;&amp; logic was found:</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/ERC20.sol">ref</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-13">Impact<a class="hash-link" href="#impact-13" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-13">Recommendation<a class="hash-link" href="#recommendation-13" title="Direct link to heading">‚Äã</a></h4><p>Replace require statements that use &amp;&amp; by dividing up the logic into multiple require statements.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="7-gas---declare-constant-internal-when-possible-engn33r">7. Gas - Declare constant internal when possible (engn33r)<a class="hash-link" href="#7-gas---declare-constant-internal-when-possible-engn33r" title="Direct link to heading">‚Äã</a></h3><p>Declaring constant with internal visibility is cheaper than public constants. This is already applied to all constants in the code except one.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-14">Proof of concept<a class="hash-link" href="#proof-of-concept-14" title="Direct link to heading">‚Äã</a></h4><p>The <code>bento</code> constant should be internal if possible:</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L89">link</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-14">Impact<a class="hash-link" href="#impact-14" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-14">Recommendation<a class="hash-link" href="#recommendation-14" title="Direct link to heading">‚Äã</a></h4><p>Make constant variables internal for gas savings.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="8-gas---replace-require-with-errors-in-openmevrouter-jackson">8. Gas - Replace require with errors in OpenMevRouter (Jackson)<a class="hash-link" href="#8-gas---replace-require-with-errors-in-openmevrouter-jackson" title="Direct link to heading">‚Äã</a></h3><p>Two require statements can be replaced with custom errors in OpenMevRouter.</p><p>Custom errors are already used elsewhere in OpenMevRouter and are more gas-efficient than require statements: <a href="https://blog.soliditylang.org/2021/04/21/custom-errors/" target="_blank" rel="noopener noreferrer">https://blog.soliditylang.org/2021/04/21/custom-errors/</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-15">Proof of concept<a class="hash-link" href="#proof-of-concept-15" title="Direct link to heading">‚Äã</a></h4><p>One in <code>_addLiquidity</code> (<code>require(amountAOptimal &lt;= amountADesired);</code>) and another in <code>addLiquidityETH</code> (<code>require(IWETH(weth).transfer(pair, amountETH));</code>, which can be replaced with <code>safeTransfer</code> as is done in <code>swapExactETHForTokens</code>).</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-15">Impact<a class="hash-link" href="#impact-15" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-15">Recommendation<a class="hash-link" href="#recommendation-15" title="Direct link to heading">‚Äã</a></h4><p>Use solidity custom errors instead of require statements.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="9-gas---remove-unused-code-jackson">9. Gas - Remove unused code (Jackson)<a class="hash-link" href="#9-gas---remove-unused-code-jackson" title="Direct link to heading">‚Äã</a></h3><p><code>RESERVE_SELECTOR</code> is not used in <code>OpenMevLibrary</code> and can be removed, neither are <code>_require()</code> or <code>_revert()</code> in <code>OpenMevErrors</code>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-16">Proof of concept<a class="hash-link" href="#proof-of-concept-16" title="Direct link to heading">‚Äã</a></h4><ol><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol#L36">link</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libstd/OpenMevErrors.sol#L9">link</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libstd/OpenMevErrors.sol#L16">link</a></li></ol><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-16">Impact<a class="hash-link" href="#impact-16" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-16">Recommendation<a class="hash-link" href="#recommendation-16" title="Direct link to heading">‚Äã</a></h4><p>Remove unused code to save gas on deployment.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="10-gas---use-simple-comparison-engn33r">10. Gas - Use simple comparison (engn33r)<a class="hash-link" href="#10-gas---use-simple-comparison-engn33r" title="Direct link to heading">‚Äã</a></h3><p>Using a compound comparison such as ‚â• or ‚â§ uses more gas than a simple comparison check like &gt;, &lt;, or ==. Compound comparison operators can be replaced with simple ones for gas savings.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-17">Proof of concept<a class="hash-link" href="#proof-of-concept-17" title="Direct link to heading">‚Äã</a></h4><p>The <code>_addLiquidity()</code> function in OpenMenRouter.sol contains
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol-L143">ref</a></p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (amountBOptimal </span><span style="color:#D32F2F">&lt;=</span><span style="color:#24292EFF"> amountBDesired) {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#C2C3C5">// require(amountBOptimal &gt;= amountBMin, &#x27;UniswapV2Router: INSUFFICIENT_B_AMOUNT&#x27;);</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (amountBOptimal </span><span style="color:#D32F2F">&lt;</span><span style="color:#24292EFF"> amountBMin) </span><span style="color:#D32F2F">revert</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">InsufficientBAmount</span><span style="color:#24292EFF">();</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#C2C3C5">// revert InsufficientBAmount({ available: amountBOptimal, required: amountBMin });</span></div><div class="line"><span style="color:#24292EFF">    (amountA</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amountB) </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> (amountADesired</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amountBOptimal);</span></div><div class="line"><span style="color:#24292EFF">} </span><span style="color:#D32F2F">else</span><span style="color:#24292EFF"> {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#1976D2">uint256</span><span style="color:#24292EFF"> amountAOptimal </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> OpenMevLibrary.</span><span style="color:#6F42C1">quote</span><span style="color:#24292EFF">(amountBDesired</span><span style="color:#212121">,</span><span style="color:#24292EFF"> reserveB</span><span style="color:#212121">,</span><span style="color:#24292EFF"> reserveA);</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">require</span><span style="color:#24292EFF">(amountAOptimal </span><span style="color:#D32F2F">&lt;=</span><span style="color:#24292EFF"> amountADesired);</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#C2C3C5">// require(amountAOptimal &gt;= amountAMin, &#x27;UniswapV2Router: INSUFFICIENT_A_AMOUNT&#x27;);</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (amountAOptimal </span><span style="color:#D32F2F">&lt;</span><span style="color:#24292EFF"> amountAMin) </span><span style="color:#D32F2F">revert</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">InsufficientAAmount</span><span style="color:#24292EFF">();</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#C2C3C5">// revert InsufficientAAmount({ available: amountAOptimal, required: amountAMin });</span></div><div class="line"><span style="color:#24292EFF">    (amountA</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amountB) </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> (amountAOptimal</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amountBDesired);</span></div><div class="line"><span style="color:#24292EFF">}</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountBOptimal </span><span style="color:#81A1C1">&lt;=</span><span style="color:#D8DEE9FF"> amountBDesired</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#616E88">// require(amountBOptimal &gt;= amountBMin, &#x27;UniswapV2Router: INSUFFICIENT_B_AMOUNT&#x27;);</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountBOptimal </span><span style="color:#81A1C1">&lt;</span><span style="color:#D8DEE9FF"> amountBMin</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">revert</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">InsufficientBAmount</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#616E88">// revert InsufficientBAmount({ available: amountBOptimal, required: amountBMin });</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountA</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amountB</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountADesired</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amountBOptimal</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">else</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#8FBCBB">uint256</span><span style="color:#D8DEE9FF"> amountAOptimal </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> OpenMevLibrary</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">quote</span><span style="color:#D8DEE9FF">(amountBDesired</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> reserveB</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> reserveA</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">require</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountAOptimal </span><span style="color:#81A1C1">&lt;=</span><span style="color:#D8DEE9FF"> amountADesired</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#616E88">// require(amountAOptimal &gt;= amountAMin, &#x27;UniswapV2Router: INSUFFICIENT_A_AMOUNT&#x27;);</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountAOptimal </span><span style="color:#81A1C1">&lt;</span><span style="color:#D8DEE9FF"> amountAMin</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">revert</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">InsufficientAAmount</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#616E88">// revert InsufficientAAmount({ available: amountAOptimal, required: amountAMin });</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountA</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amountB</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountAOptimal</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amountBDesired</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#ECEFF4">}</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><p>By switching around the if/else clauses, we can replace the compound operator with a simple one</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (amountBOptimal </span><span style="color:#D32F2F">&gt;</span><span style="color:#24292EFF"> amountBDesired) {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#1976D2">uint256</span><span style="color:#24292EFF"> amountAOptimal </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> OpenMevLibrary.</span><span style="color:#6F42C1">quote</span><span style="color:#24292EFF">(amountBDesired</span><span style="color:#212121">,</span><span style="color:#24292EFF"> reserveB</span><span style="color:#212121">,</span><span style="color:#24292EFF"> reserveA);</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">require</span><span style="color:#24292EFF">(amountAOptimal </span><span style="color:#D32F2F">&lt;=</span><span style="color:#24292EFF"> amountADesired);</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#C2C3C5">// require(amountAOptimal &gt;= amountAMin, &#x27;UniswapV2Router: INSUFFICIENT_A_AMOUNT&#x27;);</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (amountAOptimal </span><span style="color:#D32F2F">&lt;</span><span style="color:#24292EFF"> amountAMin) </span><span style="color:#D32F2F">revert</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">InsufficientAAmount</span><span style="color:#24292EFF">();</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#C2C3C5">// revert InsufficientAAmount({ available: amountAOptimal, required: amountAMin });</span></div><div class="line"><span style="color:#24292EFF">    (amountA</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amountB) </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> (amountAOptimal</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amountBDesired);</span></div><div class="line"><span style="color:#24292EFF">} </span><span style="color:#D32F2F">else</span><span style="color:#24292EFF"> {</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#C2C3C5">// require(amountBOptimal &gt;= amountBMin, &#x27;UniswapV2Router: INSUFFICIENT_B_AMOUNT&#x27;);</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (amountBOptimal </span><span style="color:#D32F2F">&lt;</span><span style="color:#24292EFF"> amountBMin) </span><span style="color:#D32F2F">revert</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">InsufficientBAmount</span><span style="color:#24292EFF">();</span></div><div class="line"><span style="color:#24292EFF">    </span><span style="color:#C2C3C5">// revert InsufficientBAmount({ available: amountBOptimal, required: amountBMin });</span></div><div class="line"><span style="color:#24292EFF">    (amountA</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amountB) </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> (amountADesired</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amountBOptimal);</span></div><div class="line"><span style="color:#24292EFF">}</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountBOptimal </span><span style="color:#81A1C1">&gt;</span><span style="color:#D8DEE9FF"> amountBDesired</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#8FBCBB">uint256</span><span style="color:#D8DEE9FF"> amountAOptimal </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> OpenMevLibrary</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">quote</span><span style="color:#D8DEE9FF">(amountBDesired</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> reserveB</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> reserveA</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">require</span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountAOptimal </span><span style="color:#81A1C1">&lt;=</span><span style="color:#D8DEE9FF"> amountADesired</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#616E88">// require(amountAOptimal &gt;= amountAMin, &#x27;UniswapV2Router: INSUFFICIENT_A_AMOUNT&#x27;);</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountAOptimal </span><span style="color:#81A1C1">&lt;</span><span style="color:#D8DEE9FF"> amountAMin</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">revert</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">InsufficientAAmount</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#616E88">// revert InsufficientAAmount({ available: amountAOptimal, required: amountAMin });</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountA</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amountB</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountAOptimal</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amountBDesired</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#ECEFF4">}</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">else</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#616E88">// require(amountBOptimal &gt;= amountBMin, &#x27;UniswapV2Router: INSUFFICIENT_B_AMOUNT&#x27;);</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountBOptimal </span><span style="color:#81A1C1">&lt;</span><span style="color:#D8DEE9FF"> amountBMin</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">revert</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">InsufficientBAmount</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#616E88">// revert InsufficientBAmount({ available: amountBOptimal, required: amountBMin });</span></div><div class="line"><span style="color:#D8DEE9FF">    </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountA</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amountB</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountADesired</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amountBOptimal</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#ECEFF4">}</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><p>Another instance of this improvement is found with the comparison <code>&gt;= 1</code>. Two other instances of this are in OpenMevLibrary.sol (lines 270 and 331), but to show the example from <code>_swapSupportingFeeOnTransferTokens()</code>
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#24292EFF">swaps[i].isBackrunable </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> ((</span><span style="color:#1976D2">1000</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">*</span><span style="color:#24292EFF"> amountInput) </span><span style="color:#D32F2F">/</span><span style="color:#24292EFF"> reserveInput) </span><span style="color:#D32F2F">&gt;=</span><span style="color:#24292EFF"> </span><span style="color:#1976D2">1</span><span style="color:#24292EFF">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#D8DEE9FF">swaps</span><span style="color:#ECEFF4">[</span><span style="color:#D8DEE9FF">i</span><span style="color:#ECEFF4">].</span><span style="color:#D8DEE9FF">isBackrunable </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">((</span><span style="color:#B48EAD">1000</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">*</span><span style="color:#D8DEE9FF"> amountInput</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">/</span><span style="color:#D8DEE9FF"> reserveInput</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">&gt;=</span><span style="color:#D8DEE9FF"> </span><span style="color:#B48EAD">1</span><span style="color:#81A1C1">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><p>Because <code>&gt;= 1</code> equates to <code>&gt; 0</code>, and G1 shows how <code>!= 0</code> or <code>_isNonZero()</code> is better than <code>&gt; 0</code>, the comparison can be simplified to</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#24292EFF">swaps[i].isBackrunable </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">_isNonZero</span><span style="color:#24292EFF">(((</span><span style="color:#1976D2">1000</span><span style="color:#24292EFF"> </span><span style="color:#D32F2F">*</span><span style="color:#24292EFF"> amountInput) </span><span style="color:#D32F2F">/</span><span style="color:#24292EFF"> reserveInput));</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#D8DEE9FF">swaps</span><span style="color:#ECEFF4">[</span><span style="color:#D8DEE9FF">i</span><span style="color:#ECEFF4">].</span><span style="color:#D8DEE9FF">isBackrunable </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">_isNonZero</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">((</span><span style="color:#B48EAD">1000</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">*</span><span style="color:#D8DEE9FF"> amountInput</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">/</span><span style="color:#D8DEE9FF"> reserveInput</span><span style="color:#ECEFF4">))</span><span style="color:#81A1C1">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-17">Impact<a class="hash-link" href="#impact-17" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-17">Recommendation<a class="hash-link" href="#recommendation-17" title="Direct link to heading">‚Äã</a></h4><p>Replace compound comparison operators with simple ones for gas savings.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="11-gas---combine-reserve-value-checks-engn33r">11. Gas - Combine reserve value checks (engn33r)<a class="hash-link" href="#11-gas---combine-reserve-value-checks-engn33r" title="Direct link to heading">‚Äã</a></h3><p><code>getAmountOut()</code> in OpenMevLibrary.sol checks if the reserve values with <code>_isZero()</code>. Most locations where <code>OpenMevLibrary.getAmountOut()</code> is called also use the check <code>if (reserve0 &lt; 1000 || reserve1 &lt; 1000)</code> before <code>getAmountOut()</code> is called. Rather than duplicating similar checks, gas could be saved by consistently checking reserve values before calling <code>getAmountOut()</code>, or requiring <code>reserve0 &lt; 1000 &amp;&amp; reserve1 &lt; 1000</code> inside <code>getAmountOut()</code>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-18">Proof of concept<a class="hash-link" href="#proof-of-concept-18" title="Direct link to heading">‚Äã</a></h4><p>Most places where <code>OpenMevLibrary.getAmountOut()</code> in OpenMevZapper results in duplicated reserve checks.
<!-- -->[link]<!-- -->(manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-18">Impact<a class="hash-link" href="#impact-18" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-18">Recommendation<a class="hash-link" href="#recommendation-18" title="Direct link to heading">‚Äã</a></h4><p>Remove duplicated reserves checks to save gas</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="12-gas---use-msg-global-vars-directly-engn33r">12. Gas - Use msg global vars directly (engn33r)<a class="hash-link" href="#12-gas---use-msg-global-vars-directly-engn33r" title="Direct link to heading">‚Äã</a></h3><p>Using msg.sender and msg.value without caching is slightly more gas efficient than caching the value.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-19">Proof of concept<a class="hash-link" href="#proof-of-concept-19" title="Direct link to heading">‚Äã</a></h4><p>msg.value is unnecessarily cached in:</p><ul><li><code>addiquidityETH()</code> <a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">link</a></li><li><code>swapETHForExactToens()</code> <a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">link</a></li><li><code>swapETHAdStakeLiquidity()</code> <a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol">link</a></li></ul><p>msg.value can replace swaps<!-- -->[0]<!-- -->.amountIn</p><ul><li><code>swapExactETHForToens()</code> <!-- -->[link]<!-- -->(manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L564 and <a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">link</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-19">Impact<a class="hash-link" href="#impact-19" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-19">Recommendation<a class="hash-link" href="#recommendation-19" title="Direct link to heading">‚Äã</a></h4><p>Improve gas efficiency by removing the caching of msg global vars to use the global vars directly</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="13-gas---remove-duplicate-internal-function-call-engn33r">13. Gas - Remove duplicate internal function call (engn33r)<a class="hash-link" href="#13-gas---remove-duplicate-internal-function-call-engn33r" title="Direct link to heading">‚Äã</a></h3><p><code>ensure()</code> gets called twice in ETH-related functions. The first call happens at the start of <code>addLiquidityETH()</code> or <code>removeLiquidityETH()</code>, and the second call happens when this function calls <code>addLiquidity()</code> or <code>removeLiquidity()</code>. However, this only helps in the case where no revert occurs, otherwise reverting earlier is better.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-20">Proof of concept<a class="hash-link" href="#proof-of-concept-20" title="Direct link to heading">‚Äã</a></h4><p>One example
Frst call: <a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">link</a>
Secod call: <a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">link</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-20">Impact<a class="hash-link" href="#impact-20" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-20">Recommendation<a class="hash-link" href="#recommendation-20" title="Direct link to heading">‚Äã</a></h4><p>Remove the <code>ensure()</code> call at the start of the ETH-related functions in OpenMevRouter.sol.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="14-gas---deadline-special-case-not-aligned-with-permit-engn33r">14. Gas - deadline special case not aligned with permit (engn33r)<a class="hash-link" href="#14-gas---deadline-special-case-not-aligned-with-permit-engn33r" title="Direct link to heading">‚Äã</a></h3><p>From EIP-2612:</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="code-container"><code><div class="line"><span style="color:undefined">The deadline argument can be set to uint(-1) to create Permits that effectively never expire.</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="code-container"><code><div class="line"><span style="color:undefined">The deadline argument can be set to uint(-1) to create Permits that effectively never expire.</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><p>In contrast, <code>ensure()</code> implies a value of zero for a deadline that never expires</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (deadline </span><span style="color:#D32F2F">&lt;</span><span style="color:#24292EFF"> block.timestamp </span><span style="color:#D32F2F">&amp;&amp;</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">_isNonZero</span><span style="color:#24292EFF">(deadline)) </span><span style="color:#D32F2F">revert</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">Expired</span><span style="color:#24292EFF">();</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">deadline </span><span style="color:#81A1C1">&lt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">block</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">timestamp </span><span style="color:#81A1C1">&amp;&amp;</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">_isNonZero</span><span style="color:#D8DEE9FF">(deadline</span><span style="color:#ECEFF4">))</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">revert</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">Expired</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-21">Proof of concept<a class="hash-link" href="#proof-of-concept-21" title="Direct link to heading">‚Äã</a></h4><p>EIP-2612 text
<a href="https://eips.ethereum.org/EIPS/eip-2612#rationale" target="_blank" rel="noopener noreferrer">https://eips.ethereum.org/EIPS/eip-2612#rationale</a></p><p><code>ensure()</code> function
<!-- -->[link]<!-- -->(manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol#L98</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-21">Impact<a class="hash-link" href="#impact-21" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-21">Recommendation<a class="hash-link" href="#recommendation-21" title="Direct link to heading">‚Äã</a></h4><p>Use the same permit approach as EIP-2612. This simplifies and aligns the check in <code>ensure()</code> to match Uniswap&#x27;s check.</p><p>Uniswap code:
/Uniswap/v2-core/blob/8b82b04a0b9e696c0e83f8b2f00e5d7be6888c79/contracts/UniswapV2ERC20.sol#L82
<code>require(deadline &gt;= block.timestamp, &#x27;UniswapV2: EXPIRED&#x27;);</code></p><p>Revised OpenMevRouter.sol <code>ensure()</code> logic:
<code>if (deadline &lt; block.timestamp) revert Expired();</code></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="15-gas---replace-pairswap-with-_asmswap-engn33r">15. Gas - Replace <code>pair.swap()</code> with <code>_asmSwap()</code> (engn33r)<a class="hash-link" href="#15-gas---replace-pairswap-with-_asmswap-engn33r" title="Direct link to heading">‚Äã</a></h3><p>One instance of <code>pair.swap()</code> has not been replaced with <code>_asmSwap()</code> for gas efficiency.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-22">Proof of concept<a class="hash-link" href="#proof-of-concept-22" title="Direct link to heading">‚Äã</a></h4><p><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-22">Impact<a class="hash-link" href="#impact-22" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-22">Recommendation<a class="hash-link" href="#recommendation-22" title="Direct link to heading">‚Äã</a></h4><p>Replace all instances of <code>pair.swap()</code> with <code>_asmSwap()</code>. This may allow the swap to be moved out of <code>_swapSupportingFeeOnTransferTokensExecute()</code> and into <code>_swapSupportingFeeOnTransferTokens()</code>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="16-gas---remove-a-sorttokens-call-engn33r">16. Gas - Remove a sortTokens call (engn33r)<a class="hash-link" href="#16-gas---remove-a-sorttokens-call-engn33r" title="Direct link to heading">‚Äã</a></h3><p><code>_swapSupportingFeeOnTransferTokens()</code> in OpenMevRouter.sol calls <code>sortTokens()</code> twice. Caching the outputs from the first call can remove the need for the 2nd call.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-23">Proof of concept<a class="hash-link" href="#proof-of-concept-23" title="Direct link to heading">‚Äã</a></h4><p>The first <code>sortTokens()</code> call:
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></p><p>The second <code>sortTokens()</code> call happens in <code>pairFor()</code>:
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-23">Impact<a class="hash-link" href="#impact-23" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-23">Recommendation<a class="hash-link" href="#recommendation-23" title="Direct link to heading">‚Äã</a></h4><p>Cache the outputs from the first <code>sortTokens()</code> call, then replace <code>OpenMevLibrary.pairFor()</code> with <code>OpenMevLibrary._asmPairFor()</code>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="17-gas---missing-curly-brace-engn33r">17. Gas - Missing curly brace (engn33r)<a class="hash-link" href="#17-gas---missing-curly-brace-engn33r" title="Direct link to heading">‚Äã</a></h3><p>The final if statement in <code>withdrawLiquidityAndSwap()</code> is missing curly braces. The code added in OpenMevZapper not found in Beefy is designed to save gas, but the curly braces are necessary to provide the gas savings. Otherwise the token swap always happens even if <code>desiredTokenOutMin</code> of <code>desiredToken</code> are already available to send to the user.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-24">Proof of concept<a class="hash-link" href="#proof-of-concept-24" title="Direct link to heading">‚Äã</a></h4><p>If statement with missing curly braces
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol">ref</a>-L115</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-24">Impact<a class="hash-link" href="#impact-24" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-24">Recommendation<a class="hash-link" href="#recommendation-24" title="Direct link to heading">‚Äã</a></h4><p>The revised code should read</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#24292EFF">        </span><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (desiredTokenOutMin </span><span style="color:#D32F2F">&gt;</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">ERC20</span><span style="color:#24292EFF">(desiredToken).</span><span style="color:#6F42C1">balanceOf</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">address</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">this</span><span style="color:#24292EFF">))) {</span></div><div class="line"><span style="color:#24292EFF">            desiredSwapAmount </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> desiredTokenOutMin </span><span style="color:#D32F2F">-</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">ERC20</span><span style="color:#24292EFF">(desiredToken).</span><span style="color:#6F42C1">balanceOf</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">address</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">this</span><span style="color:#24292EFF">));</span></div><div class="line"><span style="color:#24292EFF">            router.</span><span style="color:#6F42C1">swapExactTokensForTokens</span><span style="color:#24292EFF">(</span></div><div class="line"><span style="color:#24292EFF">                </span><span style="color:#6F42C1">ERC20</span><span style="color:#24292EFF">(swapToken).</span><span style="color:#6F42C1">balanceOf</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">address</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">this</span><span style="color:#24292EFF">))</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">                desiredSwapAmount</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">                path</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">                </span><span style="color:#1976D2">address</span><span style="color:#24292EFF">(</span><span style="color:#1976D2">this</span><span style="color:#24292EFF">)</span><span style="color:#212121">,</span></div><div class="line"><span style="color:#24292EFF">                block.timestamp</span></div><div class="line"><span style="color:#24292EFF">            );</span></div><div class="line"><span style="color:#24292EFF">        }</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">desiredTokenOutMin </span><span style="color:#81A1C1">&gt;</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">ERC20</span><span style="color:#D8DEE9FF">(desiredToken</span><span style="color:#ECEFF4">).</span><span style="color:#88C0D0">balanceOf</span><span style="color:#D8DEE9FF">(</span><span style="color:#8FBCBB">address</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">)))</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">{</span></div><div class="line"><span style="color:#D8DEE9FF">            desiredSwapAmount </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> desiredTokenOutMin </span><span style="color:#81A1C1">-</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">ERC20</span><span style="color:#D8DEE9FF">(desiredToken</span><span style="color:#ECEFF4">).</span><span style="color:#88C0D0">balanceOf</span><span style="color:#D8DEE9FF">(</span><span style="color:#8FBCBB">address</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">))</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">            router</span><span style="color:#ECEFF4">.</span><span style="color:#88C0D0">swapExactTokensForTokens</span><span style="color:#D8DEE9FF">(</span></div><div class="line"><span style="color:#D8DEE9FF">                </span><span style="color:#88C0D0">ERC20</span><span style="color:#D8DEE9FF">(swapToken</span><span style="color:#ECEFF4">).</span><span style="color:#88C0D0">balanceOf</span><span style="color:#D8DEE9FF">(</span><span style="color:#8FBCBB">address</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">)),</span></div><div class="line"><span style="color:#D8DEE9FF">                desiredSwapAmount</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">                path</span><span style="color:#ECEFF4">,</span></div><div class="line"><span style="color:#D8DEE9FF">                </span><span style="color:#8FBCBB">address</span><span style="color:#ECEFF4">(</span><span style="color:#81A1C1">this</span><span style="color:#ECEFF4">),</span></div><div class="line"><span style="color:#D8DEE9FF">                </span><span style="color:#81A1C1">block</span><span style="color:#ECEFF4">.</span><span style="color:#D8DEE9FF">timestamp</span></div><div class="line"><span style="color:#D8DEE9FF">            </span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div><div class="line"><span style="color:#D8DEE9FF">        </span><span style="color:#ECEFF4">}</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><h3 class="anchor anchorWithStickyNavbar_mojV" id="18-gas---more-efficient-variable-swap-engn33r">18. Gas - More efficient variable swap (engn33r)<a class="hash-link" href="#18-gas---more-efficient-variable-swap-engn33r" title="Direct link to heading">‚Äã</a></h3><p><code>_arb()</code> has an inefficient approach to swapping variables around.</p><p><a href="https://blog.oliverjumpertz.dev/solidity-quick-tip-efficiently-swap-two-variables" target="_blank" rel="noopener noreferrer">https://blog.oliverjumpertz.dev/solidity-quick-tip-efficiently-swap-two-variables</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-25">Proof of concept<a class="hash-link" href="#proof-of-concept-25" title="Direct link to heading">‚Äã</a></h4><p>The original variables in line 1114
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol">ref</a></p><p>The inefficiently swapped variables in line 1128
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol">ref</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-25">Impact<a class="hash-link" href="#impact-25" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-25">Recommendation<a class="hash-link" href="#recommendation-25" title="Direct link to heading">‚Äã</a></h4><p>Swap the variables around in line 1128 like this:</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#24292EFF">(amount0Out</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amount1Out) </span><span style="color:#D32F2F">=</span><span style="color:#24292EFF"> (amount1Out</span><span style="color:#212121">,</span><span style="color:#24292EFF"> amount0Out);</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amount0Out</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amount1Out</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">=</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amount1Out</span><span style="color:#ECEFF4">,</span><span style="color:#D8DEE9FF"> amount0Out</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><h3 class="anchor anchorWithStickyNavbar_mojV" id="19-gas---reduce-number-of-swaps-engn33r">19. Gas - Reduce number of swaps (engn33r)<a class="hash-link" href="#19-gas---reduce-number-of-swaps-engn33r" title="Direct link to heading">‚Äã</a></h3><p>There are three steps in the swap and arb process. The steps are: 1. Perform the user swap with factory0 2. Perform arb with a swap in the opposite direction with optimalAmount on factory0 3. Continue the arb with a swap in the initial direction on factory1. The first two steps (swap and arb on the same factory liquidity pool) can be combined because the 2nd step is effectively reversing a part of the first step. Because the end goal is to remove a price differential between the Uniswap and SushiSwap pools, this can be achieved by splitting the initial user swap between the Uniswap and SushiSwap pools to optimize the overall exchange rate rather than by arbing a larger swap that happens in a single LP. The profit for OpenMevRouter can be taken from the improved exchange rate (returning the user tokens based on the exchange rate if the swap happened in only one LP) rather than taking profit from the arb.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-26">Proof of concept<a class="hash-link" href="#proof-of-concept-26" title="Direct link to heading">‚Äã</a></h4><p>Consider the constant product diagram
<img loading="lazy" alt="Constant Product Swaps" src="/assets/images/constant_product_swaps-44e14919f83da24231ea6afe30b47dfe.jpg" width="864" height="816" class="img_E7b_"></p><p>Point 1 shows the liquidity pool amounts before OpenMevRouter interaction, point 2 shows the amounts after the OpenMevRouter user swap, and point 3 shows the amounts after the first backrun of the arb process. These two steps can be combined to arrive from point 1 to point 3, skipping to need to swap to arrive at point 2. The math in OpenMevRouter.sol would need changing, but gas savings from removing one swap may be enough to reduce overall gas consumption.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-26">Impact<a class="hash-link" href="#impact-26" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-26">Recommendation<a class="hash-link" href="#recommendation-26" title="Direct link to heading">‚Äã</a></h4><p>Remove a swap by combining the user swap and the first step of the backrun that reverse the user swap by exchanging output token to input token.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="20-gas---revert-if-zero-flashloan-profit-engn33r">20. Gas - Revert if zero flashloan profit (engn33r)<a class="hash-link" href="#20-gas---revert-if-zero-flashloan-profit-engn33r" title="Direct link to heading">‚Äã</a></h3><p>If there is no profit realized from the flashloan arb, the flashloan should revert to save remaining gas just like it would revert if there is loss of value.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-27">Proof of concept<a class="hash-link" href="#proof-of-concept-27" title="Direct link to heading">‚Äã</a></h4><p>The revert logic for the kashi flashloan callback is currently:
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a>)</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (amountOver </span><span style="color:#D32F2F">&lt;</span><span style="color:#24292EFF"> amountOwing) </span><span style="color:#D32F2F">revert</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">InsufficientOutputAmount</span><span style="color:#24292EFF">();</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountOver </span><span style="color:#81A1C1">&lt;</span><span style="color:#D8DEE9FF"> amountOwing</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">revert</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">InsufficientOutputAmount</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><p>Instead, the revert should also happen on the equality case:</p><pre class="shiki min-light" style="background-color:#ffffff;color:#24292eff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#D32F2F">if</span><span style="color:#24292EFF"> (amountOver </span><span style="color:#D32F2F">&lt;=</span><span style="color:#24292EFF"> amountOwing) </span><span style="color:#D32F2F">revert</span><span style="color:#24292EFF"> </span><span style="color:#6F42C1">InsufficientOutputAmount</span><span style="color:#24292EFF">();</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><pre class="shiki nord" style="background-color:#2e3440ff;color:#d8dee9ff"><div class="language-id">solidity</div><div class="code-container"><code><div class="line"><span style="color:#81A1C1">if</span><span style="color:#D8DEE9FF"> </span><span style="color:#ECEFF4">(</span><span style="color:#D8DEE9FF">amountOver </span><span style="color:#81A1C1">&lt;=</span><span style="color:#D8DEE9FF"> amountOwing</span><span style="color:#ECEFF4">)</span><span style="color:#D8DEE9FF"> </span><span style="color:#81A1C1">revert</span><span style="color:#D8DEE9FF"> </span><span style="color:#88C0D0">InsufficientOutputAmount</span><span style="color:#D8DEE9FF">(</span><span style="color:#ECEFF4">)</span><span style="color:#81A1C1">;</span></div></code></div><button type="button" aria-label="Copy code to clipboard" class="copy-button">Copy</button></pre><p>The same improvement can be made in the Aave flashloan callback.
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-27">Impact<a class="hash-link" href="#impact-27" title="Direct link to heading">‚Äã</a></h4><p>Gas savings</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-27">Recommendation<a class="hash-link" href="#recommendation-27" title="Direct link to heading">‚Äã</a></h4><p>Revert on zero profit case.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="informational-findings">Informational Findings<a class="hash-link" href="#informational-findings" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-informational---openmevrouter-should-inherit-from-iflashborrower-and-iopenmevrouter-jackson">1. Informational - OpenMevRouter should inherit from IFlashBorrower and IOpenMevRouter (Jackson)<a class="hash-link" href="#1-informational---openmevrouter-should-inherit-from-iflashborrower-and-iopenmevrouter-jackson" title="Direct link to heading">‚Äã</a></h3><p>OpenMevRouter should also inherit from IFlashBorrower and IOpenMevRouter aside from TwoStepOwnable.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-28">Impact<a class="hash-link" href="#impact-28" title="Direct link to heading">‚Äã</a></h4><p>Type safety.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-informational---the-etherscan_api-key-is-present-in-plaintext-jackson">2. Informational - The ETHERSCAN_API key is present in plaintext (Jackson)<a class="hash-link" href="#2-informational---the-etherscan_api-key-is-present-in-plaintext-jackson" title="Direct link to heading">‚Äã</a></h3><p><code>ETHERSCAN_API</code> is present in plaintext in test_Swaps.py</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-29">Impact<a class="hash-link" href="#impact-29" title="Direct link to heading">‚Äã</a></h4><p>Malicious use of your Etherscan API key.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-informational---safetransferlib-does-not-match-solmates-main-branch-jackson">3. Informational - SafeTransferLib does not match Solmate&#x27;s main branch (Jackson)<a class="hash-link" href="#3-informational---safetransferlib-does-not-match-solmates-main-branch-jackson" title="Direct link to heading">‚Äã</a></h3><p>The SafeTransferLib does not match Solmate&#x27;s latest implementation.  Consider whether an update would be useful or save gas.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-30">Impact<a class="hash-link" href="#impact-30" title="Direct link to heading">‚Äã</a></h4><p>Possible gas savings.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="4-informational---incorrect-comment-engn33r-jackson">4. Informational - Incorrect comment (engn33r, Jackson)<a class="hash-link" href="#4-informational---incorrect-comment-engn33r-jackson" title="Direct link to heading">‚Äã</a></h3><p>A comment in OpenMevRouter.sol has an extra function argument that doesn&#x27;t exist in the code.</p><p>Elsewhere, in <code>addLiquidityETH()</code></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-28">Proof of concept<a class="hash-link" href="#proof-of-concept-28" title="Direct link to heading">‚Äã</a></h4><p>The comment on line 1001 doesn&#x27;t match the code in line 1002
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a>-L1002</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-31">Impact<a class="hash-link" href="#impact-31" title="Direct link to heading">‚Äã</a></h4><p>Informational</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-28">Recommendation<a class="hash-link" href="#recommendation-28" title="Direct link to heading">‚Äã</a></h4><p>Remove the extra function argument</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="5-informational---replace-magic-numbers-with-constants-engn33r">5. Informational - Replace magic numbers with constants (engn33r)<a class="hash-link" href="#5-informational---replace-magic-numbers-with-constants-engn33r" title="Direct link to heading">‚Äã</a></h3><p>Constant variables should be used in place of magic numbers to prevent typos. For one example, the magic number 1000 is found in multiple places in OpenMevRouter.sol and should be replaced with a constant. Using a constant also adds a description using the variable name to explain what this value is for. This will not change gas consumption.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-29">Proof of concept<a class="hash-link" href="#proof-of-concept-29" title="Direct link to heading">‚Äã</a></h4><p>There are many instances of the value 1000. Consider replacing this magic number with a constant internal variable named MINIMUM_LIQUIDITY <a href="/Uniswap/v2-core/blob/8b82b04a0b9e696c0e83f8b2f00e5d7be6888c79/contracts/UniswapV2Pair.sol#L15">like Uniswap does</a>:</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol#L57-L58">link</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevZapper.sol">ref</a></li></ul><p>Other instances of magic numbers are found in <code>calcCoeffs()</code>:</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol-427">ref</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-32">Impact<a class="hash-link" href="#impact-32" title="Direct link to heading">‚Äã</a></h4><p>Informational</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-29">Recommendation<a class="hash-link" href="#recommendation-29" title="Direct link to heading">‚Äã</a></h4><p>Use constant variables instead of magic numbers</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="6-informational---typos-engn33r">6. Informational - Typos (engn33r)<a class="hash-link" href="#6-informational---typos-engn33r" title="Direct link to heading">‚Äã</a></h3><p><code>balanaceToDistribute</code> might be better named <code>balanceToDistribute</code>. <code>isBackrunable</code> might be better named <code>isBackrunnable</code>.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-30">Proof of concept<a class="hash-link" href="#proof-of-concept-30" title="Direct link to heading">‚Äã</a></h4><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol#L28">link</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-33">Impact<a class="hash-link" href="#impact-33" title="Direct link to heading">‚Äã</a></h4><p>Informational</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-30">Recommendation<a class="hash-link" href="#recommendation-30" title="Direct link to heading">‚Äã</a></h4><p>Fix typos</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="7-informational---hard-coded-aave-token-list-engn33r">7. Informational - Hard coded Aave token list (engn33r)<a class="hash-link" href="#7-informational---hard-coded-aave-token-list-engn33r" title="Direct link to heading">‚Äã</a></h3><p>Aave can modify their list of supported tokens that support flashloans. The <code>aaveList()</code> function in OpenMevLibrary.sol stores a hard coded list of these tokens, meaning OpenMevRouter does not support a way of updating its internal list of tokens supporting Aave flashloans.</p><p>The list in the contract does match the list of supported Aave tokens at the time of this review: <a href="https://aave.github.io/aave-addresses/mainnet.json" target="_blank" rel="noopener noreferrer">https://aave.github.io/aave-addresses/mainnet.json</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-31">Proof of concept<a class="hash-link" href="#proof-of-concept-31" title="Direct link to heading">‚Äã</a></h4><p>The hard coded list of tokens in OpenMevLibrary.sol
<a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/OpenMevLibrary.sol">ref</a></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-34">Impact<a class="hash-link" href="#impact-34" title="Direct link to heading">‚Äã</a></h4><p>Informational</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-31">Recommendation<a class="hash-link" href="#recommendation-31" title="Direct link to heading">‚Äã</a></h4><p>Store Aave token addresses in a state variable that has a setter function with the onlyOwner modifier to enable changes to the Aave token list.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="8-informational---inconsistency-in-weth-transfers-engn33r">8. Informational - Inconsistency in WETH transfers (engn33r)<a class="hash-link" href="#8-informational---inconsistency-in-weth-transfers-engn33r" title="Direct link to heading">‚Äã</a></h3><p>There is one inconsistent instance of WETH transfer. Consider using a consistent approach for gas savings and code simplification.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-32">Proof of concept<a class="hash-link" href="#proof-of-concept-32" title="Direct link to heading">‚Äã</a></h4><p>The one instance of a WETH transfer with <code>require(IWETH(weth).transfer(pair, amount));</code></p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li></ul><p>All other instances use <code>IWETH(weth).deposit{ value: amount }();</code></p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-35">Impact<a class="hash-link" href="#impact-35" title="Direct link to heading">‚Äã</a></h4><p>Informational</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-32">Recommendation<a class="hash-link" href="#recommendation-32" title="Direct link to heading">‚Äã</a></h4><p>Use consistent WETH transfer approach.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="9-informational---safeapprove-vulnerable-to-double-withdraw-engn33r">9. Informational - safeApprove vulnerable to double withdraw (engn33r)<a class="hash-link" href="#9-informational---safeapprove-vulnerable-to-double-withdraw-engn33r" title="Direct link to heading">‚Äã</a></h3><p>Using <code>approve()</code> or <code>safeApprove()</code> adds the risk of a double withdrawal:
<a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#IERC20-approve-address-uint256-" target="_blank" rel="noopener noreferrer">https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#IERC20-approve-address-uint256-</a></p><p>The same race condition applies to <code>permit()</code>:
<a href="https://eips.ethereum.org/EIPS/eip-2612#security-considerations" target="_blank" rel="noopener noreferrer">https://eips.ethereum.org/EIPS/eip-2612#security-considerations</a></p><p>Furthermore, the <code>safeApprove()</code> function is deprecated per OpenZeppelin docs:
/OpenZeppelin/openzeppelin-contracts/blob/57725120581e27ec469e1c7e497a4008aafff818/contracts/token/ERC20/utils/SafeERC20.sol#L39-L58</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-33">Proof of concept<a class="hash-link" href="#proof-of-concept-33" title="Direct link to heading">‚Äã</a></h4><p>One relevant <code>safeApprove()</code> call was found:</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li></ul><p>Permit is used in several functions in OpenMevRouter.sol:</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-36">Impact<a class="hash-link" href="#impact-36" title="Direct link to heading">‚Äã</a></h4><p>Informational. This has not been shown to be a notable problem on mainnet, but better solutions do exist.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-33">Recommendation<a class="hash-link" href="#recommendation-33" title="Direct link to heading">‚Äã</a></h4><p>Use <code>safeIncreaseAllowance()</code> or <code>safeDecreaseAllowance()</code> instead of <code>safeApprove()</code>.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="10-informational---same-frontrunning-weaknesses-as-uniswapsushiswap-engn33r">10. Informational - Same frontrunning weaknesses as Uniswap/SushiSwap (engn33r)<a class="hash-link" href="#10-informational---same-frontrunning-weaknesses-as-uniswapsushiswap-engn33r" title="Direct link to heading">‚Äã</a></h3><p>While the description of this protection is to prevent MEV extraction with a specific form of MEV, there is no protection for other forms of MEV. This is acknowledged by the devs in <a href="/manifoldfinance/OpenMevRouter/wiki/V01-Router-Spec-Doc#front-running-and-transaction-reordering">project documentation</a>, with acknowledgement that Uniswap does not protect against this either. Attack vectors such as frontrunning or an uncle bandit attack can extract value from transactions that swap with OpenMevRouter.sol because only backrun arbitrage MEV protection is built into the OpenMevRouter design.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-34">Proof of concept<a class="hash-link" href="#proof-of-concept-34" title="Direct link to heading">‚Äã</a></h4><p>Project documentation explaining these attack vectors still remain:
/manifoldfinance/OpenMevRouter/wiki/V01-Router-Spec-Doc#front-running-and-transaction-reordering</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-37">Impact<a class="hash-link" href="#impact-37" title="Direct link to heading">‚Äã</a></h4><p>Informational</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-34">Recommendation<a class="hash-link" href="#recommendation-34" title="Direct link to heading">‚Äã</a></h4><p>Clarify user documentation to make it clear that <code>amountOutMin</code> or a similarly named function argument is still an important slippage setting in OpenMevRouter.sol and OpenMevZapper.sol.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="11-informational---kashi-flashloanable-tokens-assumed-same-as-aave-engn33r">11. Informational - Kashi flashloanable tokens assumed same as aave (engn33r)<a class="hash-link" href="#11-informational---kashi-flashloanable-tokens-assumed-same-as-aave-engn33r" title="Direct link to heading">‚Äã</a></h3><p>The list of tokens that can be flashloaned with Kashi is assumed to be the same as the list of tokens that can be flashloaned from Aave. If there is a token that can be flashloaned with Kashi, the <code>_backrunSwaps()</code> function will never perform a backrun with this token even though it may result in profit.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-35">Proof of concept<a class="hash-link" href="#proof-of-concept-35" title="Direct link to heading">‚Äã</a></h4><p>The logic to backrun a swap happens if either there is sufficient token balance in the router that no flashloan is needed, or the token can be flashloaned from Aave. There is no separate list of Kashi-supported flashloanable tokens. Only a list of Aave flashloanable tokens exists.</p><ul><li><a href="/router/manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/OpenMevRouter.sol">ref</a></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-38">Impact<a class="hash-link" href="#impact-38" title="Direct link to heading">‚Äã</a></h4><p>Informational</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-35">Recommendation<a class="hash-link" href="#recommendation-35" title="Direct link to heading">‚Äã</a></h4><p>Add a list of Kashi flashloanable tokens to allow profitable backruns if Kashi supports more flashloanable tokens than Aave.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="12-informational----engn33r">12. Informational -  (engn33r)<a class="hash-link" href="#12-informational----engn33r" title="Direct link to heading">‚Äã</a></h3><p>The <code>add512x512()</code> additional function has a comment copied from <code>sub512x512()</code> which reads &quot;Calculates the difference of two uint512&quot;. It should instead read &quot;Calculates the sum of two uint512&quot;.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="proof-of-concept-36">Proof of concept<a class="hash-link" href="#proof-of-concept-36" title="Direct link to heading">‚Äã</a></h4><p>Incorrect comment for <code>add512x512()</code>:</p><ul><li>[link]<!-- -->(manifoldfinance/OpenMevRouter/blob/8648277c0a89d0091f959948682543bdcf0c280b/contracts/libraries/Uint512.sol#L67</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="impact-39">Impact<a class="hash-link" href="#impact-39" title="Direct link to heading">‚Äã</a></h4><p>Informational</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="recommendation-36">Recommendation<a class="hash-link" href="#recommendation-36" title="Direct link to heading">‚Äã</a></h4><p>Fix the comment as described to properly describe function purpose.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="final-remarks">Final remarks<a class="hash-link" href="#final-remarks" title="Direct link to heading">‚Äã</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="engn33r">engn33r<a class="hash-link" href="#engn33r" title="Direct link to heading">‚Äã</a></h3><p>The custom logic around the backrun to capture MEV and the corresponding whitepaper with equation derivations is well thought out and implemented. The main points of concern are actually the modifications made to forked code from Uniswap and Beefy, as the high risk findings indicate. The gas savings optimizations applied to the OpenMevRouter contracts are above and beyond the level of most projects. I think this project can play an important role in the future of MEV and the solid code structure gives me confidence it can properly fill this role.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="jackson">Jackson<a class="hash-link" href="#jackson" title="Direct link to heading">‚Äã</a></h3><p>This is one of those ideas that you think &quot;why didn&#x27;t I think of that?&quot;.  I&#x27;m excited for it to go into production and see what the effects will be for both users and holders of Sushi.  The number, type, and breadth of tests give me confidence in the correctness of the implementation.  My only concerns are around whether we missed something related to the intention of the implementation as most of the high and medium findings seem to suggest.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="about-yacademy">About yAcademy<a class="hash-link" href="#about-yacademy" title="Direct link to heading">‚Äã</a></h2><p>yAcademy is an ecosystem initiative started by Yearn Finance and its ecosystem partners to bootstrap sustainable and collaborative blockchain security reviews and to nurture aspiring security talent.  yAcademy includes a fellowship program and a residents program.  In the fellowship program, fellows perform a series of periodic security reviews and presentations during the program. Residents are past fellows who continue to gain experience by performing security reviews of contracts submitted to yAcademy for review (such as this contract).</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="appendix-and-faq">Appendix and FAQ<a class="hash-link" href="#appendix-and-faq" title="Direct link to heading">‚Äã</a></h2></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/openmev/docs/edit/main/docs/router/audit.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/RPC-Methods"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">OpenMEV API</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#review-summary" class="table-of-contents__link toc-highlight">Review Summary</a></li><li><a href="#scope" class="table-of-contents__link toc-highlight">Scope</a></li><li><a href="#code-evaluation-matrix" class="table-of-contents__link toc-highlight">Code Evaluation Matrix</a></li><li><a href="#findings-explanation" class="table-of-contents__link toc-highlight">Findings Explanation</a></li><li><a href="#high-findings" class="table-of-contents__link toc-highlight">High Findings</a><ul><li><a href="#1-high---the-swap-and-stake-mechanisms-in-openmevzapper-leave-funds-in-the-contract-jackson" class="table-of-contents__link toc-highlight">1. High - The swap and stake mechanisms in OpenMevZapper leave funds in the contract (Jackson)</a></li><li><a href="#2-high---using-normal-functions-for-fee-on-transfer-tokens-causes-value-loss-engn33r" class="table-of-contents__link toc-highlight">2. High - Using normal functions for fee-on-transfer tokens causes value loss (engn33r)</a></li><li><a href="#3-high---backrun-arb-not-designed-for-fee-on-transfer-tokens-engn33r" class="table-of-contents__link toc-highlight">3. High - Backrun arb not designed for fee-on-transfer tokens (engn33r)</a></li></ul></li><li><a href="#medium-findings" class="table-of-contents__link toc-highlight">Medium Findings</a><ul><li><a href="#1-medium---failed-flashloan-arbitrage-reverts-the-original-swap-jackson" class="table-of-contents__link toc-highlight">1. Medium - Failed flashloan arbitrage reverts the original swap (Jackson)</a></li></ul></li><li><a href="#low-findings" class="table-of-contents__link toc-highlight">Low Findings</a><ul><li><a href="#1-low---edge-case-suboptimal-arb-profit-engn33r" class="table-of-contents__link toc-highlight">1. Low - Edge case suboptimal arb profit (engn33r)</a></li><li><a href="#2-low---one-failed-arb-can-revert-otherwise-profitable-arb-engn33r" class="table-of-contents__link toc-highlight">2. Low - One failed arb can revert otherwise profitable arb (engn33r)</a></li><li><a href="#3-low---max-approval-granted-to-spender-jackson" class="table-of-contents__link toc-highlight">3. Low - Max approval granted to spender (Jackson)</a></li><li><a href="#4-low---no-check-for-aave-flashloan-balance-jackson" class="table-of-contents__link toc-highlight">4. Low - No check For Aave flashloan balance (Jackson)</a></li></ul></li><li><a href="#gas-savings-findings" class="table-of-contents__link toc-highlight">Gas Savings Findings</a><ul><li><a href="#1-gas---use-_isnonzero-for-gas-savings-engn33r" class="table-of-contents__link toc-highlight">1. Gas - Use <code>_isNonZero()</code> for gas savings (engn33r)</a></li><li><a href="#2-gas---use-_inc-instead-of--and-_dec-instead-of----engn33r" class="table-of-contents__link toc-highlight">2. Gas - Use <code>_inc()</code> instead of <code>++</code> and <code>_dec()</code> instead of <code>--</code> (engn33r)</a></li><li><a href="#3-gas---bitshifting-is-cheaper-than-multiplication-or-division-engn33r" class="table-of-contents__link toc-highlight">3. Gas - Bitshifting is cheaper than multiplication or division (engn33r)</a></li><li><a href="#4-gas---unnecessary-zero-initialization-engn33r" class="table-of-contents__link toc-highlight">4. Gas - Unnecessary zero initialization (engn33r)</a></li><li><a href="#5-gas---payable-functions-can-save-gas-engn33r" class="table-of-contents__link toc-highlight">5. Gas - Payable functions can save gas (engn33r)</a></li><li><a href="#6-gas---avoid--logic-in-require-statements-engn33r" class="table-of-contents__link toc-highlight">6. Gas - Avoid &amp;&amp; logic in require statements (engn33r)</a></li><li><a href="#7-gas---declare-constant-internal-when-possible-engn33r" class="table-of-contents__link toc-highlight">7. Gas - Declare constant internal when possible (engn33r)</a></li><li><a href="#8-gas---replace-require-with-errors-in-openmevrouter-jackson" class="table-of-contents__link toc-highlight">8. Gas - Replace require with errors in OpenMevRouter (Jackson)</a></li><li><a href="#9-gas---remove-unused-code-jackson" class="table-of-contents__link toc-highlight">9. Gas - Remove unused code (Jackson)</a></li><li><a href="#10-gas---use-simple-comparison-engn33r" class="table-of-contents__link toc-highlight">10. Gas - Use simple comparison (engn33r)</a></li><li><a href="#11-gas---combine-reserve-value-checks-engn33r" class="table-of-contents__link toc-highlight">11. Gas - Combine reserve value checks (engn33r)</a></li><li><a href="#12-gas---use-msg-global-vars-directly-engn33r" class="table-of-contents__link toc-highlight">12. Gas - Use msg global vars directly (engn33r)</a></li><li><a href="#13-gas---remove-duplicate-internal-function-call-engn33r" class="table-of-contents__link toc-highlight">13. Gas - Remove duplicate internal function call (engn33r)</a></li><li><a href="#14-gas---deadline-special-case-not-aligned-with-permit-engn33r" class="table-of-contents__link toc-highlight">14. Gas - deadline special case not aligned with permit (engn33r)</a></li><li><a href="#15-gas---replace-pairswap-with-_asmswap-engn33r" class="table-of-contents__link toc-highlight">15. Gas - Replace <code>pair.swap()</code> with <code>_asmSwap()</code> (engn33r)</a></li><li><a href="#16-gas---remove-a-sorttokens-call-engn33r" class="table-of-contents__link toc-highlight">16. Gas - Remove a sortTokens call (engn33r)</a></li><li><a href="#17-gas---missing-curly-brace-engn33r" class="table-of-contents__link toc-highlight">17. Gas - Missing curly brace (engn33r)</a></li><li><a href="#18-gas---more-efficient-variable-swap-engn33r" class="table-of-contents__link toc-highlight">18. Gas - More efficient variable swap (engn33r)</a></li><li><a href="#19-gas---reduce-number-of-swaps-engn33r" class="table-of-contents__link toc-highlight">19. Gas - Reduce number of swaps (engn33r)</a></li><li><a href="#20-gas---revert-if-zero-flashloan-profit-engn33r" class="table-of-contents__link toc-highlight">20. Gas - Revert if zero flashloan profit (engn33r)</a></li></ul></li><li><a href="#informational-findings" class="table-of-contents__link toc-highlight">Informational Findings</a><ul><li><a href="#1-informational---openmevrouter-should-inherit-from-iflashborrower-and-iopenmevrouter-jackson" class="table-of-contents__link toc-highlight">1. Informational - OpenMevRouter should inherit from IFlashBorrower and IOpenMevRouter (Jackson)</a></li><li><a href="#2-informational---the-etherscan_api-key-is-present-in-plaintext-jackson" class="table-of-contents__link toc-highlight">2. Informational - The ETHERSCAN_API key is present in plaintext (Jackson)</a></li><li><a href="#3-informational---safetransferlib-does-not-match-solmates-main-branch-jackson" class="table-of-contents__link toc-highlight">3. Informational - SafeTransferLib does not match Solmate&#39;s main branch (Jackson)</a></li><li><a href="#4-informational---incorrect-comment-engn33r-jackson" class="table-of-contents__link toc-highlight">4. Informational - Incorrect comment (engn33r, Jackson)</a></li><li><a href="#5-informational---replace-magic-numbers-with-constants-engn33r" class="table-of-contents__link toc-highlight">5. Informational - Replace magic numbers with constants (engn33r)</a></li><li><a href="#6-informational---typos-engn33r" class="table-of-contents__link toc-highlight">6. Informational - Typos (engn33r)</a></li><li><a href="#7-informational---hard-coded-aave-token-list-engn33r" class="table-of-contents__link toc-highlight">7. Informational - Hard coded Aave token list (engn33r)</a></li><li><a href="#8-informational---inconsistency-in-weth-transfers-engn33r" class="table-of-contents__link toc-highlight">8. Informational - Inconsistency in WETH transfers (engn33r)</a></li><li><a href="#9-informational---safeapprove-vulnerable-to-double-withdraw-engn33r" class="table-of-contents__link toc-highlight">9. Informational - safeApprove vulnerable to double withdraw (engn33r)</a></li><li><a href="#10-informational---same-frontrunning-weaknesses-as-uniswapsushiswap-engn33r" class="table-of-contents__link toc-highlight">10. Informational - Same frontrunning weaknesses as Uniswap/SushiSwap (engn33r)</a></li><li><a href="#11-informational---kashi-flashloanable-tokens-assumed-same-as-aave-engn33r" class="table-of-contents__link toc-highlight">11. Informational - Kashi flashloanable tokens assumed same as aave (engn33r)</a></li><li><a href="#12-informational----engn33r" class="table-of-contents__link toc-highlight">12. Informational -  (engn33r)</a></li></ul></li><li><a href="#final-remarks" class="table-of-contents__link toc-highlight">Final remarks</a><ul><li><a href="#engn33r" class="table-of-contents__link toc-highlight">engn33r</a></li><li><a href="#jackson" class="table-of-contents__link toc-highlight">Jackson</a></li></ul></li><li><a href="#about-yacademy" class="table-of-contents__link toc-highlight">About yAcademy</a></li><li><a href="#appendix-and-faq" class="table-of-contents__link toc-highlight">Appendix and FAQ</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">What Is OpenMEV?</a></li><li class="footer__item"><a class="footer__link-item" href="/technical-reference/intro">Technical Reference</a></li><li class="footer__item"><a class="footer__link-item" href="/api">API</a></li><li class="footer__item"><a class="footer__link-item" href="/references">References</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://forums.manifoldfinace.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forums<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/foldfinance" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/foldfinance" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://status.openmev.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Status<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="#" class="footer__link-item">Dashboard</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 Manifold Finance, Inc. | All rights reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.5bcf3360.js"></script>
<script src="/assets/js/main.451485d3.js"></script>
</body>
</html>